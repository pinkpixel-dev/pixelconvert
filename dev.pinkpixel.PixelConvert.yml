app-id: dev.pinkpixel.PixelConvert
runtime: org.gnome.Platform
runtime-version: "49"
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: pixelconvert

finish-args:
  # Display access
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland

  # GPU acceleration
  - --device=dri

  # File system access
  - --filesystem=xdg-documents
  - --filesystem=xdg-pictures
  - --filesystem=xdg-download
  - --filesystem=xdg-run/gvfsd

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
  env:
    CARGO_HOME: /run/build/pixelconvert/cargo
    RUSTFLAGS: --remap-path-prefix=../=

modules:
  # libwebp for WebP support
  - name: libwebp
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DWEBP_BUILD_ANIM_UTILS=OFF
      - -DWEBP_BUILD_CWEBP=OFF
      - -DWEBP_BUILD_DWEBP=OFF
      - -DWEBP_BUILD_GIF2WEBP=OFF
      - -DWEBP_BUILD_IMG2WEBP=OFF
      - -DWEBP_BUILD_VWEBP=OFF
      - -DWEBP_BUILD_WEBPINFO=OFF
      - -DWEBP_BUILD_WEBPMUX=OFF
      - -DWEBP_BUILD_EXTRAS=OFF
    cleanup:
      - /share
      - /bin
    sources:
      - type: archive
        url: https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.4.0.tar.gz
        sha256: 61f873ec69e3be1b99535634340d5bde750b2e4447caa1db9f61be3fd49ab1e5

  # libheif for HEIF/HEIC support
  - name: libheif
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DWITH_EXAMPLES=OFF
      - -DWITH_GDK_PIXBUF=OFF
    cleanup:
      - /bin
      - /share
    sources:
      - type: archive
        url: https://github.com/strukturag/libheif/releases/download/v1.18.2/libheif-1.18.2.tar.gz
        sha256: c4002a622bec9f519f29d84bfdc6024e33fd67953a5fb4dc2c2f11f67d5e45bf

  # dav1d for AVIF (AV1 decoder)
  - name: dav1d
    buildsystem: meson
    config-opts:
      - -Denable_tools=false
      - -Denable_tests=false
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://downloads.videolan.org/pub/videolan/dav1d/1.4.3/dav1d-1.4.3.tar.xz
        sha256: 42fe524bcc82ea3a830057178faace22923a79bad3d819a4962d8cfc54c36f19

  # Main application
  - name: pixelconvert
    buildsystem: meson
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/pixelconvert/cargo
    sources:
      - type: dir
        path: .
      - pixelconvert-cargo-sources.json
